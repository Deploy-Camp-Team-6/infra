#!/bin/bash
# Security audit script for {{ ansible_fqdn }}
# Generated on {{ ansible_date_time.iso8601 }}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Log file
LOG_FILE="/var/log/security-audit.log"

echo -e "${YELLOW}=== Security Audit Report for $(hostname) ($(date)) ===${NC}" | tee -a "$LOG_FILE"

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# 1. System Information
echo -e "\n${GREEN}[*] System Information${NC}" | tee -a "$LOG_FILE"
echo "Hostname: $(hostname)" | tee -a "$LOG_FILE"
echo "Kernel: $(uname -r)" | tee -a "$LOG_FILE"
echo "Uptime: $(uptime)" | tee -a "$LOG_FILE"

# 2. Check for security updates
if command_exists apt; then
    echo -e "\n${GREEN}[*] Checking for security updates${NC}" | tee -a "$LOG_FILE"
    apt update >/dev/null 2>&1
    UPDATES=$(apt list --upgradable 2>/dev/null | grep -v "Listing..." | wc -l)
    echo "$UPDATES updates available" | tee -a "$LOG_FILE"
    
    # Check for security updates specifically
    SEC_UPDATES=$(apt-get -s dist-upgrade | grep -i security | wc -l)
    echo "$SEC_UPDATES security updates available" | tee -a "$LOG_FILE"
fi

# 3. Check failed login attempts
if [ -f "/var/log/auth.log" ]; then
    echo -e "\n${GREEN}[*] Failed login attempts (last 10)${NC}" | tee -a "$LOG_FILE"
    grep -i "failed" /var/log/auth.log | tail -n 10 | tee -a "$LOG_FILE"
fi

# 4. Check for root login
if [ -f "/var/log/auth.log" ]; then
    echo -e "\n${GREEN}[*] Root login attempts (last 10)${NC}" | tee -a "$LOG_FILE"
    grep -i "root" /var/log/auth.log | grep -v "sudo" | tail -n 10 | tee -a "$LOG_FILE"
fi

# 5. Check listening ports
echo -e "\n${GREEN}[*] Listening ports${NC}" | tee -a "$LOG_FILE"
if command_exists ss; then
    ss -tulnp | tee -a "$LOG_FILE"
elif command_exists netstat; then
    netstat -tulnp | tee -a "$LOG_FILE"
fi

# 6. Check for SUID/SGID files
echo -e "\n${GREEN}[*] Checking for SUID/SGID files${NC}" | tee -a "$LOG_FILE"
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -la {} \; 2>/dev/null | tee -a "$LOG_FILE"

# 7. Check for world-writable files
echo -e "\n${GREEN}[*] Checking for world-writable files${NC}" | tee -a "$LOG_FILE"
find / -type f -perm -o+w -exec ls -la {} \; 2>/dev/null | head -n 20 | tee -a "$LOG_FILE"

# 8. Check for unauthorized cron jobs
echo -e "\n${GREEN}[*] Checking for cron jobs${NC}" | tee -a "$LOG_FILE"
ls -la /etc/cron* | tee -a "$LOG_FILE"

# 9. Check disk usage
echo -e "\n${GREEN}[*] Disk usage${NC}" | tee -a "$LOG_FILE"
df -h | tee -a "$LOG_FILE"

# 10. Check memory usage
echo -e "\n${GREEN}[*] Memory usage${NC}" | tee -a "$LOG_FILE"
free -m | tee -a "$LOG_FILE"

echo -e "\n${YELLOW}=== End of Security Audit ===${NC}" | tee -a "$LOG_FILE"

exit 0
