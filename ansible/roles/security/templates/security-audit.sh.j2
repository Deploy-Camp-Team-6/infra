#!/bin/bash

# Security Audit Script
# Generated on {{ ansible_date_time.iso8601 }}

AUDIT_LOG="/var/log/security-audit.log"
REPORT_FILE="/var/log/security-report-$(date +%Y%m%d).txt"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$AUDIT_LOG"
}

# Start security audit
log "Starting security audit"

{
    echo "=================================="
    echo "Security Audit Report"
    echo "Date: $(date)"
    echo "Host: $(hostname)"
    echo "=================================="
    echo

    # Check for failed login attempts
    echo "=== Failed Login Attempts (Last 24h) ==="
    grep "Failed password" /var/log/auth.log | tail -20
    echo

    # Check listening ports
    echo "=== Open Ports ==="
    ss -tuln
    echo

    # Check running services
    echo "=== Running Services ==="
    systemctl list-units --type=service --state=running
    echo

    # Check user accounts
    echo "=== User Accounts ==="
    awk -F: '$3 >= 1000 {print $1, $3, $7}' /etc/passwd
    echo

    # Check sudo usage
    echo "=== Recent Sudo Usage ==="
    grep "sudo:" /var/log/auth.log | tail -10
    echo

    # Check disk usage
    echo "=== Disk Usage ==="
    df -h
    echo

    # Check memory usage
    echo "=== Memory Usage ==="
    free -h
    echo

    # Check load average
    echo "=== System Load ==="
    uptime
    echo

    # Check for updates
    echo "=== Available Updates ==="
    apt list --upgradable 2>/dev/null | wc -l
    echo

} > "$REPORT_FILE"

log "Security audit completed: $REPORT_FILE"